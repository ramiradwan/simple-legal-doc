# ============================================================================  
# Signer (Seal‑Engine) — Cryptographic Sealing Sidecar  
# ============================================================================  
  
  
# ============================================================================  
# Stage 1: Builder (Deterministic Dependency Resolution)  
# ============================================================================  
FROM python:3.13-slim AS builder  
  
# ---------------------------------------------------------------------------  
# uv bootstrap (pinned, modern)  
# ---------------------------------------------------------------------------  
COPY --from=ghcr.io/astral-sh/uv:0.10.4 /uv /uvx /bin/  
  
ENV UV_COMPILE_BYTECODE=1  
  
# ---------------------------------------------------------------------------  
# Working directory  
# ---------------------------------------------------------------------------  
WORKDIR /app  
  
# ---------------------------------------------------------------------------  
# System dependencies  
# ---------------------------------------------------------------------------  
RUN apt-get update && apt-get install -y --no-install-recommends \  
    ca-certificates \  
 && rm -rf /var/lib/apt/lists/*  
  
# ---------------------------------------------------------------------------  
# Python dependencies (locked, reproducible)  
# ---------------------------------------------------------------------------  
# (paths are relative to signer/ build context)  
COPY pyproject.toml uv.lock ./  
  
RUN uv sync --no-dev --frozen  
  
  
# ============================================================================  
# Stage 2: Runtime (Minimal & Secure)  
# ============================================================================  
FROM python:3.13-slim  
  
# ---------------------------------------------------------------------------  
# Environment  
# ---------------------------------------------------------------------------  
ENV PYTHONUNBUFFERED=1 \  
    PYTHONDONTWRITEBYTECODE=1 \  
    LANG=C.UTF-8 \  
    LC_ALL=C.UTF-8 \  
    PYTHONPATH=/app \  
    PATH="/app/.venv/bin:$PATH"  
  
# ---------------------------------------------------------------------------  
# Working directory  
# ---------------------------------------------------------------------------  
WORKDIR /app  
  
# ---------------------------------------------------------------------------  
# System dependencies  
# ---------------------------------------------------------------------------  
RUN apt-get update && apt-get install -y --no-install-recommends \  
    ca-certificates \  
 && apt-get clean \  
 && rm -rf /var/lib/apt/lists/*  
  
# ---------------------------------------------------------------------------  
# Python virtual environment  
# ---------------------------------------------------------------------------  
COPY --from=builder /app/.venv /app/.venv  
  
# ---------------------------------------------------------------------------  
# Runtime user (non‑root)  
# ---------------------------------------------------------------------------  
RUN useradd --create-home --shell /usr/sbin/nologin appuser  
  
# ---------------------------------------------------------------------------  
# Application code  
# ---------------------------------------------------------------------------  
# Copy the signer package (context root)  
COPY --chown=appuser:appuser . /app/signer  
  
USER appuser  
  
# ---------------------------------------------------------------------------  
# Network  
# ---------------------------------------------------------------------------  
EXPOSE 8080  
  
# ---------------------------------------------------------------------------  
# Entrypoint  
# ---------------------------------------------------------------------------  
CMD ["uvicorn", "signer.app.main:app", "--host", "0.0.0.0", "--port", "8080"]  