services:  
  backend:  
    build:  
      context: .  
      dockerfile: backend/Dockerfile  
    image: simple-legal-doc-backend  
    ports:  
      - "8000:8000"  
    env_file:  
      - .env.backend  
    environment:  
      - TEMPLATE_DIR=/app/app/templates  
      - SIGNING_P12_PATH=/run/dev-cert/dev-signing.p12  
      - SIGNING_P12_PASSWORD=dev-only  
    volumes:  
      - ./backend/app/templates:/app/app/templates  
    restart: unless-stopped  
  
  frontend:  
    build:  
      context: ./frontend  
      dockerfile: Dockerfile  
    image: simple-legal-doc-frontend  
    ports:  
      - "5173:80"  
    environment:  
      - VITE_API_BASE_URL=http://backend:8000  
    depends_on:  
      - backend  
    restart: unless-stopped  
  
  proxy:  
      profiles: ["trusted"]  
      image: vimagick/tinyproxy:latest  
      volumes:  
        - ./proxy/tinyproxy.conf:/etc/tinyproxy/tinyproxy.conf:ro  
      restart: unless-stopped  

  signer:  
    profiles: ["trusted"]  
    build:  
      context: ./signer  
      dockerfile: Dockerfile  
    image: simple-legal-doc-signer  
    env_file:  
      - .env.signer  
    environment:  
      - HTTP_PROXY=http://proxy:8888 
      - HTTPS_PROXY=http://proxy:8888
    depends_on:  
      - proxy  
    restart: unless-stopped  
    read_only: true  
    tmpfs:  
      - /tmp  
    deploy:  
      resources:  
        limits:  
          memory: 128M  
    healthcheck:  
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/healthz"]  
      interval: 10s  
      timeout: 5s  
      retries: 3  
      start_period: 5s  
  
  auditor:  
    build:  
      context: .  
      dockerfile: auditor/Dockerfile  
    image: simple-legal-doc-auditor  
    env_file:  
      - .env.auditor  
    volumes:  
      - ./auditor:/app/auditor  
    working_dir: /app  
    ports:  
      - "8001:8000"  
    restart: unless-stopped  